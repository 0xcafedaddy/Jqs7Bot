<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Jqs7Bot</title>
</head>

<body id="body">
  <div align="center">
    <div id="search" align="center" class="item" style="margin-bottom:10px;margin-top:20px;height:90px;width:1200px">
      <h1 style="color: #3C3C3C">群组娘第二舰队活动图</h1>
      <div class="ui icon input">
        <input id="user" type="text" placeholder="UserName...">
        <i id="us" class="search link icon"></i>
      </div>
    </div>
  </div>
  <div align="center">
    <div class="ui" id="total" style="height:500px;width:1200px"></div>
  </div>
  <div>
    <span id="xxx"></span>
  </div>
  <div align="center">
    <div class="ui" id="pie" style="height:500px;width:1200px"></div>
  </div>
  <div class="ui inverted vertical footer segment">
    <div class="ui center aligned container">
      <div class="ui stackable inverted divided grid">
        <div class=" wide column">
          <h4 class="ui inverted header">群组娘第二舰队</h4>
          <div class="ui inverted link list">

            <a href="http://www.pixiv.net/member_illust.php?mode=medium&illust_id=28762438" class="item">群组娘的头像</a>
            <a href="https://github.com/jqs7/telegram-chinese-groups" class="item">群组娘的源代码基于 GPL v3 协议发布项目地址</a>
          </div>
        </div>
      </div>
      <div class="ui inverted section divider"></div>
      <img src="http://chuantu.biz/t2/13/1442342559x-1376440126.jpg" class="ui centered mini image">
      <p>本群组列表采用知识共享署名-非商业性使用 4.0 国际许可协议进行许可。</p>
      <a href="http://creativecommons.org/licenses/by-nc/4.0/">http://creativecommons.org/licenses/by-nc/4.0/</a><br/>
      <div class="ui horizontal inverted small divided link list">
        <a class="item" href="#">Site Map</a>
        <a class="item" href="#">Contact Us</a>
        <a class="item" href="#">Terms and Conditions</a>
        <a class="item" href="#">Privacy Policy</a>
      </div>
    </div>
  </div>
</body>

</html>

<script src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
<link href="//cdn.bootcss.com/semantic-ui/2.1.3/semantic.min.css" rel="stylesheet">
<script src="//cdn.bootcss.com/echarts/2.2.7/echarts.js"></script>
<script type="text/javascript">
  require.config({
    paths: {
      echarts: '//cdn.bootcss.com/echarts/2.2.7'
    }
  });
  require(
          [
            'echarts',
            'zrender',
            'echarts/config',
            'zrender/config',
            'echarts/chart/pie',
            'echarts/chart/line'
          ],
          function (ec) {
            var total = ec.init(document.getElementById('total'));
            var pie = ec.init(document.getElementById('pie'));
            var user;
            $("#pie").hide();
            $("#user").keyup(function () {
              if (event.keyCode == 13) {
                user = localStorage.user = $("#user").val();
                window.location.href = '/user/@' + user;
              }
            });
            $("#us").click(function () {
              user = localStorage.user = $("#user").val();
              window.location.href = '/user/@'+user;
            });

            var total_option = {
              legend:{
                data:["日发言量","日活跃用户"]
              },
              tooltip: {
                show: true,
                enterable: true,
                formatter: function (params, ticket, callback) {
                  if (params['seriesName']=="日活跃用户"){
                    if ($.inArray(params['name'],["avg","min","max"]) != -1){
                      return '<div class="ui blue label">'+params['name']+ '</div></br>'+ params['data']['value']+'</br>';
                    }
                    return '<div class="ui blue label">'+params['name']+ '</div></br>'+ params['data']+'</br>';
                  }
                  if (params['data'] == "") {
                    params['data'] = "0"
                  }
                  if ($.inArray(params['name'],["avg","min","max"]) != -1){
                    return '<div class="ui blue label">'+params['name']+ '</div></br>'+ params['data']['value']+'</br>';
                  }
                  var res = '<div style="margin-bottom:10px"><div class="ui blue label" style="margin-right:10px">' +
                      params['name'] + '</div><div class="ui blue label">' + params['data'] + '</div></div>';
                  $.ajax({
                    url: "/test/" + params['name']
                  }).done(function (data) {
                    for (var i in data['rank']) {
                      var percent = Number(data['rank'][i]['percent']);
                      percent = percent.toFixed(2);
                      var name = data['rank'][i]['name'];
                      var count = data['rank'][i]['count'];
                      res += '<div style="margin-bottom:3px"><div class="ui circular pink label"><a href="/user/' +
                              encodeURI(name) + '">' + name + '</a></div>' +
                              '<div class="ui circular yellow label">' + count +
                              '</div><div class="ui circular violet label">'+percent+'%</div></div>';
                    }
                    callback(ticket, res);
                  });
                  return 'loading';
                },
                hideDelay: 3000
              },
              yAxis: [{},{
                scale: true
              }],
              xAxis: [
                {
                  data: [{{range $element := .total}}{{with $element}}{{.date.Format "2006-01-02"}},{{end}}{{end}}]
                }
              ],
              series: [
                {
                  name: "日发言量",
                  type: "line",
                  yAxisIndex:0,
                  smooth: true,
                  data: [{{range $element := .total}}{{with $element}}{{.total}},{{end}}{{end}}],
                  markPoint: {
                    data: [
                      {type: 'max',name: 'max'},
                      {type: 'min',name: 'min'},
                    ]
                  }
                },
                {
                  name: "日活跃用户",
                  type: "line",
                  yAxisIndex:1,
                  smooth: true,
                  data: [{{range $element := .users}}{{with $element}}{{.userCount}},{{end}}{{end}}],
                  markLine: {
                    data: [
                      {type: 'average', name: 'avg'}
                    ]
                  },
                  markPoint:{
                    data: [
                      {type: 'max',name:'max'},
                      {type: 'min',name:'min'}
                    ]
                  }
                }
              ]
            };
  total.setOption(total_option);
  total.on('click',
          function eConsole(param){
            function piedata(value,name){
              var pie = new Object;
              pie.value = value;
              pie.name = name;
              return pie;
            }
            var data1 = new Array;
            var other;
            var pname;
            var len;
            var sum =0;
            console.log(param['data']);
            if(param['seriesName']=="日发言量" && param['data']!=Object && $.inArray(param['name'],["avg","min","max"]) == -1){
              $("#pie").show();
              $.ajax({
                url: "/test/" + param['name']
              }).done(function (data) {
                pname = param['name'];
                other = param['data'];
                len = data['rank'].length;
                for (var i in data['rank']) {
                  data1[i] = piedata(data['rank'][i]['count'], data['rank'][i]['name']);
                  sum += data['rank'][i]['count'];
                  if (i == (len - 1)) {
                    other = other - sum;
                    i++;
                    data1[i] = piedata(other, '其他');
                  }
                }
                var click_option = {
                  series: [
                    {
                      name: "日活跃用户",
                      type: "pie",
                      smooth: true,
                      center: [ '50%' , '60%'],
                      radius: '55%',
                      boundaryGap : true,
                      data:data1
                    }
                  ]
                };
                pie.setOption(click_option);
              });
            }else{
              $("#pie").hide();
            }


            console.log(param);
          }
  );
  }
  );

</script>
